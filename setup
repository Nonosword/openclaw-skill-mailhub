#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   ./setup --dir <SKILL_DIR> [--source env] [--mode openclaw|standalone] [--openclaw-json <path>]
#   ./setup [SKILL_DIR]
# Example:
#   ~/.openclaw/skills/mailhub/setup --dir ~/.openclaw/skills/mailhub --source env --mode standalone --openclaw-json ~/.openclaw/openclaw.json

usage() {
  cat <<'EOF'
Usage:
  setup --dir <SKILL_DIR> [--source env] [--mode openclaw|standalone] [--openclaw-json <path>]
  setup [SKILL_DIR]

Options:
  --dir <path>     Skill working directory (default: script directory).
  --source env     Load <SKILL_DIR>/.env during setup and in launcher runtime.
  --mode <value>   Routing mode: openclaw (default) or standalone.
  --openclaw-json  Path to openclaw.json (default: ~/.openclaw/openclaw.json).
  -h, --help       Show this help.
EOF
}

SKILL_DIR=""
SOURCE_MODE="none"
MODE="openclaw"
OPENCLAW_JSON="${HOME}/.openclaw/openclaw.json"
POSITIONAL=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    --dir)
      [[ $# -ge 2 ]] || { echo "[setup] --dir requires a path" >&2; exit 2; }
      SKILL_DIR="$2"
      shift 2
      ;;
    --source)
      [[ $# -ge 2 ]] || { echo "[setup] --source requires a value" >&2; exit 2; }
      SOURCE_MODE="$2"
      shift 2
      ;;
    --mode)
      [[ $# -ge 2 ]] || { echo "[setup] --mode requires a value" >&2; exit 2; }
      MODE="$2"
      shift 2
      ;;
    --openclaw-json)
      [[ $# -ge 2 ]] || { echo "[setup] --openclaw-json requires a path" >&2; exit 2; }
      OPENCLAW_JSON="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    --*)
      echo "[setup] unknown option: $1" >&2
      usage
      exit 2
      ;;
    *)
      POSITIONAL+=("$1")
      shift
      ;;
  esac
done

if [[ -z "${SKILL_DIR}" ]]; then
  if [[ ${#POSITIONAL[@]} -gt 0 ]]; then
    SKILL_DIR="${POSITIONAL[0]}"
  else
    SKILL_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  fi
fi

case "${SOURCE_MODE}" in
  none|env) ;;
  *)
    echo "[setup] unsupported --source value: ${SOURCE_MODE} (supported: env)" >&2
    exit 2
    ;;
esac

case "${MODE}" in
  openclaw|standalone) ;;
  *)
    echo "[setup] unsupported --mode value: ${MODE} (supported: openclaw|standalone)" >&2
    exit 2
    ;;
esac

if [[ "${SOURCE_MODE}" == "env" ]]; then
  ENV_FILE="${SKILL_DIR}/.env"
  if [[ -f "${ENV_FILE}" ]]; then
    echo "[setup] loading env from ${ENV_FILE}"
    set -a
    # shellcheck disable=SC1090
    source "${ENV_FILE}"
    set +a
  else
    echo "[setup] --source env requested but .env not found at ${ENV_FILE}" >&2
  fi
fi

VENV_DIR="${MAILHUB_VENV_DIR:-${SKILL_DIR}/.venv}"
STATE_DIR="${MAILHUB_STATE_DIR:-${HOME}/.openclaw/state/mailhub}"
LAUNCHER="${HOME}/.local/bin/mailhub"

if [[ ! -d "${SKILL_DIR}" ]]; then
  echo "[setup] skill dir not found: ${SKILL_DIR}" >&2
  exit 1
fi

if command -v uv >/dev/null 2>&1; then
  echo "[setup] using uv to create virtualenv: ${VENV_DIR}"
  uv venv "${VENV_DIR}"
  uv pip install --python "${VENV_DIR}/bin/python" -e "${SKILL_DIR}"
else
  if ! command -v python3 >/dev/null 2>&1; then
    echo "[setup] python3 is required (or install uv)." >&2
    exit 1
  fi
  echo "[setup] uv not found, falling back to python3 -m venv"
  python3 -m venv "${VENV_DIR}"
  "${VENV_DIR}/bin/pip" install -e "${SKILL_DIR}"
fi

mkdir -p "${STATE_DIR}"
mkdir -p "$(dirname "${LAUNCHER}")"

cat > "${LAUNCHER}" <<EOF
#!/usr/bin/env bash
set -euo pipefail
export MAILHUB_SKILL_DIR="${SKILL_DIR}"
export MAILHUB_ENV_FILE="\${MAILHUB_ENV_FILE:-${SKILL_DIR}/.env}"
export MAILHUB_MODE="\${MAILHUB_MODE:-${MODE}}"
export MAILHUB_OPENCLAW_JSON_PATH="\${MAILHUB_OPENCLAW_JSON_PATH:-${OPENCLAW_JSON}}"
if [[ "${SOURCE_MODE}" == "env" ]]; then
  ENV_FILE="${SKILL_DIR}/.env"
  if [[ -f "\${ENV_FILE}" ]]; then
    set -a
    # shellcheck disable=SC1090
    source "\${ENV_FILE}"
    set +a
  fi
fi
export MAILHUB_STATE_DIR="\${MAILHUB_STATE_DIR:-${STATE_DIR}}"
exec "${VENV_DIR}/bin/mailhub" "\$@"
EOF

chmod +x "${LAUNCHER}"

echo "[setup] installed launcher: ${LAUNCHER}"
if [[ ":${PATH}:" != *":${HOME}/.local/bin:"* ]]; then
  echo "[setup] PATH does not contain ${HOME}/.local/bin"
  echo "[setup] add this to shell profile:"
  echo "export PATH=\"${HOME}/.local/bin:\$PATH\""
fi

echo "[setup] running doctor..."
"${LAUNCHER}" doctor
echo "[setup] configuring routing mode=${MODE}"
"${LAUNCHER}" settings-set routing.mode "${MODE}"
"${LAUNCHER}" settings-set routing.openclaw_json_path "${OPENCLAW_JSON}"
if [[ "${MODE}" == "standalone" ]]; then
  echo "[setup] standalone mode selected."
  echo "[setup] set standalone agent command with:"
  echo "  mailhub settings-set routing.standalone_agent_cmd '<your-agent-command>'"
fi
echo "[setup] done."
